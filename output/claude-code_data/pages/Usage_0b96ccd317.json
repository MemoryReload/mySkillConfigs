{
  "title": "Usage",
  "content": "async def main():\n    tracker = CostTracker()\n    result = await tracker.track_conversation(\"Analyze and refactor this code\")\n\nprint(f\"Steps processed: {len(result['step_usages'])}\")\n    print(f\"Total cost: ${result['total_cost']:.4f}\")\n\nasyncio.run(main())\ntypescript\ninterface CacheUsage {\n  cache_creation_input_tokens: number;\n  cache_read_input_tokens: number;\n  cache_creation: {\n    ephemeral_5m_input_tokens: number;\n    ephemeral_1h_input_tokens: number;\n  };\n}\ntypescript\nclass BillingAggregator {\n  private userUsage = new Map<string, {\n    totalTokens: number;\n    totalCost: number;\n    conversations: number;\n  }>();\n  \n  async processUserRequest(userId: string, prompt: string) {\n    const tracker = new CostTracker();\n    const { result, stepUsages, totalCost } = await tracker.trackConversation(prompt);\n    \n    // Update user totals\n    const current = this.userUsage.get(userId) || {\n      totalTokens: 0,\n      totalCost: 0,\n      conversations: 0\n    };\n    \n    const totalTokens = stepUsages.reduce((sum, step) => \n      sum + step.usage.input_tokens + step.usage.output_tokens, 0\n    );\n    \n    this.userUsage.set(userId, {\n      totalTokens: current.totalTokens + totalTokens,\n      totalCost: current.totalCost + totalCost,\n      conversations: current.conversations + 1\n    });\n    \n    return result;\n  }\n  \n  getUserBilling(userId: string) {\n    return this.userUsage.get(userId) || {\n      totalTokens: 0,\n      totalCost: 0,\n      conversations: 0\n    };\n  }\n}\n```\n\n## Related Documentation\n\n- [TypeScript SDK Reference](/docs/en/agent-sdk/typescript) - Complete API documentation\n- [SDK Overview](/docs/en/agent-sdk/overview) - Getting started with the SDK\n- [SDK Permissions](/docs/en/agent-sdk/permissions) - Managing tool permissions",
  "code_samples": [
    {
      "code": "</CodeGroup>\n\n## Handling Edge Cases\n\n### Output Token Discrepancies\n\nIn rare cases, you might observe different `output_tokens` values for messages with the same ID. When this occurs:\n\n1. **Use the highest value** - The final message in a group typically contains the accurate total\n2. **Verify against total cost** - The `total_cost_usd` in the result message is authoritative\n3. **Report inconsistencies** - File issues at the [Claude Code GitHub repository](https://github.com/anthropics/claude-code/issues)\n\n### Cache Token Tracking\n\nWhen using prompt caching, track these token types separately:",
      "language": "unknown"
    },
    {
      "code": "## Best Practices\n\n1. **Use Message IDs for Deduplication**: Always track processed message IDs to avoid double-charging\n2. **Monitor the Result Message**: The final result contains authoritative cumulative usage\n3. **Implement Logging**: Log all usage data for auditing and debugging\n4. **Handle Failures Gracefully**: Track partial usage even if a conversation fails\n5. **Consider Streaming**: For streaming responses, accumulate usage as messages arrive\n\n## Usage Fields Reference\n\nEach usage object contains:\n\n- `input_tokens`: Base input tokens processed\n- `output_tokens`: Tokens generated in the response\n- `cache_creation_input_tokens`: Tokens used to create cache entries\n- `cache_read_input_tokens`: Tokens read from cache\n- `service_tier`: The service tier used (e.g., \"standard\")\n- `total_cost_usd`: Total cost in USD (only in result message)\n\n## Example: Building a Billing Dashboard\n\nHere's how to aggregate usage data for a billing dashboard:",
      "language": "unknown"
    }
  ],
  "headings": [
    {
      "level": "h2",
      "text": "Handling Edge Cases",
      "id": "handling-edge-cases"
    },
    {
      "level": "h3",
      "text": "Output Token Discrepancies",
      "id": "output-token-discrepancies"
    },
    {
      "level": "h3",
      "text": "Cache Token Tracking",
      "id": "cache-token-tracking"
    },
    {
      "level": "h2",
      "text": "Best Practices",
      "id": "best-practices"
    },
    {
      "level": "h2",
      "text": "Usage Fields Reference",
      "id": "usage-fields-reference"
    },
    {
      "level": "h2",
      "text": "Example: Building a Billing Dashboard",
      "id": "example:-building-a-billing-dashboard"
    },
    {
      "level": "h2",
      "text": "Related Documentation",
      "id": "related-documentation"
    },
    {
      "level": "h3",
      "text": "MCP in the API",
      "id": "mcp-in-the-api"
    }
  ],
  "url": "llms-txt#usage",
  "links": []
}